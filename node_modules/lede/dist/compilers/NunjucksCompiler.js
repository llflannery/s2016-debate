"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
const nunjucks_1 = require("nunjucks");
const path_1 = require("path");
const fs_extra_1 = require("fs-extra");
function readStreamProm(path) {
    let data = "";
    let stream = fs_extra_1.createReadStream(path);
    return new Promise((resolve, reject) => {
        stream.on('data', d => data += d.toString());
        stream.on('end', () => resolve(data));
        stream.on('error', e => reject(e));
    });
}
class NunjucksCompiler {
    constructor(opts = { watch: false, noCache: true, autoescape: false }) {
        this.opts = opts;
    }
    compile(report, compilers) {
        return __awaiter(this, void 0, void 0, function* () {
            let bits = NunjucksCompiler.getUsedBits(report);
            let stylesBlock = yield NunjucksCompiler.createStyleBlock(report, bits, compilers.css);
            let scriptsBlock = yield NunjucksCompiler.createScriptsBlock(report, bits, compilers.js);
            let shell = yield NunjucksCompiler.createShell(report, stylesBlock, scriptsBlock);
            return {
                index: yield NunjucksCompiler.renderTemplate(report, shell, this.opts),
                scripts: scriptsBlock,
                styles: stylesBlock,
                cachePath: path_1.join(report.workingDirectory, '.ledeCache')
            };
        });
    }
    static createScriptsBlock(report, bits, compiler) {
        return __awaiter(this, void 0, void 0, function* () {
            let scripts = yield compiler.compile(report, bits);
            return {
                file: 'globalScripts.js',
                data: `
// GLOBALS
${scripts.globals}
// BITS
${scripts.bits}
`
            };
        });
    }
    static getUsedBits(report) {
        let visitedBits = [];
        if (report.context.content.ARTICLE) {
            for (let bit of report.context.content.ARTICLE) {
                if (!(visitedBits.indexOf(bit.tmpl) > -1)) {
                    visitedBits.push(bit.tmpl);
                }
            }
        }
        return visitedBits;
    }
    static renderTemplate(report, template, opts) {
        return __awaiter(this, void 0, void 0, function* () {
            let loader = new nunjucks_1.FileSystemLoader();
            loader.init([path_1.join(report.workingDirectory, '.ledeCache', 'bits')], opts);
            let env = new nunjucks_1.Environment(loader);
            if (opts.filters) {
                for (let f of opts.filters) {
                    env.addFilter(f.name, f.fn);
                }
            }
            let tmpl = new nunjucks_1.Template(template, env);
            return tmpl.render(report.context);
        });
    }
    static createStyleBlock(report, bits, compiler) {
        return __awaiter(this, void 0, void 0, function* () {
            let styles = yield compiler.compile(report, bits);
            return {
                file: 'globalStyles.css',
                data: `
/* GLOBALS */
${styles.globals}
/* BITS */
${styles.bits}
`
            };
        });
    }
    static createShell(report, stylesBlock, scriptsBlock) {
        return __awaiter(this, void 0, void 0, function* () {
            let pageTop = `
<!DOCTYPE html>

<html>
<head>
  <title>{{seo.title}}</title>
  {% for item in seo.meta -%}
  <meta{%if item.name %} name="{{item.name}}"{% endif %}{% if item.content %} content="{{item.content}}"{% endif %}{% if item.props | length %}{% for prop in item.props %} {{prop.prop}}="{{prop.val}}"{% endfor %}{% endif %} />
  {% endfor %}{% if $debug -%}
  <meta NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
  {%- endif %}
  <link rel="stylesheet" type="text/css" href="${stylesBlock.file}">
  {% if headLinks %}
    {% for link in headLinks %}
      {{ link | safe }}
    {% endfor %}
  {% endif %}
</head>
<body>
`;
            let pageBottom = `
  <script type="text/javascript" src="${scriptsBlock.file}"></script>
  {% if bodyLinks %}
    {% for link in bodyLinks %}
      {{ link | safe }}
    {% endfor %}
  {% endif %}
  {% if $debug %}
<script>
  document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] +
  ':35729/livereload.js?snipver=1"></' + 'script>')
</script>{% endif %}
</body>
</html>
`;
            let middle = '';
            for (let block of report.blocks) {
                if (block !== 'ARTICLE') {
                    middle += yield readStreamProm(path_1.join(report.workingDirectory, '.ledeCache', 'blocks', block));
                }
                else {
                    middle += `<article id="ledeRoot" class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 main-column">
            {% for bit in content.ARTICLE %}{% include bit.tmpl + "/tmpl.html" %}
            {% endfor %}
            </div>
          </div>
        </article>`;
                }
            }
            return pageTop + middle + pageBottom;
        });
    }
}
exports.NunjucksCompiler = NunjucksCompiler;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBpbGVycy9OdW5qdWNrc0NvbXBpbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLDJCQUF3RCxVQUFVLENBQUMsQ0FBQTtBQUNuRSx1QkFBcUIsTUFBTSxDQUFDLENBQUE7QUFDNUIsMkJBQWlDLFVBQVUsQ0FBQyxDQUFBO0FBRzVDLHdCQUF3QixJQUFJO0lBQzFCLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUNkLElBQUksTUFBTSxHQUFHLDJCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BDLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNO1FBQ2pDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDN0MsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUN0QyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDckMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQ7SUFFRSxZQUFtQixJQUFJLEdBQUcsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBQztRQUF2RCxTQUFJLEdBQUosSUFBSSxDQUFtRDtJQUFHLENBQUM7SUFFeEUsT0FBTyxDQUFDLE1BQU0sRUFBRSxTQUFTOztZQUM3QixJQUFJLElBQUksR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDaEQsSUFBSSxXQUFXLEdBQUcsTUFBTSxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN2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QUMsQ0FBQztZQUNsRCxNQUFNLENBQUM7Z0JBQ0wsSUFBSSxFQUFFLGtCQUFrQjtnQkFDeEIsSUFBSSxFQUFFOztFQUVWLE1BQU0sQ0FBQyxPQUFPOztFQUVkLE1BQU0sQ0FBQyxJQUFJO0NBQ1o7YUFDSSxDQUFDO1FBQ0osQ0FBQztLQUFBO0lBRUQsT0FBYSxXQUFXLENBQUMsTUFBTSxFQUFFLFdBQVcsRUFBRSxZQUFZOztZQUN4RCxJQUFJLE9BQU8sR0FBRzs7Ozs7Ozs7Ozs7aURBVytCLFdBQVcsQ0FBQyxJQUFJOzs7Ozs7OztDQVFoRSxDQUFDO1lBRUUsSUFBSSxVQUFVLEdBQUc7d0NBQ21CLFlBQVksQ0FBQyxJQUFJOzs7Ozs7Ozs7Ozs7O0NBYXhELENBQUM7WUFFRSxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7WUFDaEIsR0FBRyxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ2hDLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO29CQUN4QixNQUFNLElBQUksTUFBTSxjQUFjLENBQUMsV0FBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7Z0JBQy9GLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ04sTUFBTSxJQUFJOzs7Ozs7O21CQU9DLENBQUE7Z0JBQ2IsQ0FBQztZQUVILENBQUM7WUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sR0FBRyxVQUFVLENBQUM7UUFDdkMsQ0FBQztLQUFBO0FBQ0gsQ0FBQztBQTdIWSx3QkFBZ0IsbUJBNkg1QixDQUFBIiwiZmlsZSI6ImNvbXBpbGVycy9OdW5qdWNrc0NvbXBpbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW52aXJvbm1lbnQsIEZpbGVTeXN0ZW1Mb2FkZXIsIFRlbXBsYXRlIH0gZnJvbSBcIm51bmp1Y2tzXCI7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IGNyZWF0ZVJlYWRTdHJlYW0gfSBmcm9tIFwiZnMtZXh0cmFcIjtcblxuXG5mdW5jdGlvbiByZWFkU3RyZWFtUHJvbShwYXRoKSB7XG4gIGxldCBkYXRhID0gXCJcIjtcbiAgbGV0IHN0cmVhbSA9IGNyZWF0ZVJlYWRTdHJlYW0ocGF0aCk7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgc3RyZWFtLm9uKCdkYXRhJywgZCA9PiBkYXRhICs9IGQudG9TdHJpbmcoKSk7XG4gICAgc3RyZWFtLm9uKCdlbmQnLCAoKSA9PiByZXNvbHZlKGRhdGEpKTtcbiAgICBzdHJlYW0ub24oJ2Vycm9yJywgZSA9PiByZWplY3QoZSkpO1xuICB9KTtcbn1cblxuZXhwb3J0IGNsYXNzIE51bmp1Y2tzQ29tcGlsZXIge1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBvcHRzID0ge3dhdGNoOiBmYWxzZSwgbm9DYWNoZTogdHJ1ZSwgYXV0b2VzY2FwZTogZmFsc2V9KSB7fVxuXG4gIGFzeW5jIGNvbXBpbGUocmVwb3J0LCBjb21waWxlcnMpIHtcbiAgICBsZXQgYml0cyA9IE51bmp1Y2tzQ29tcGlsZXIuZ2V0VXNlZEJpdHMocmVwb3J0KTtcbiAgICBsZXQgc3R5bGVzQmxvY2sgPSBhd2FpdCBOdW5qdWNrc0NvbXBpbGVyLmNyZWF0ZVN0eWxlQmxvY2socmVwb3J0LCBiaXRzLCBjb21waWxlcnMuY3NzKTtcbiAgICBsZXQgc2NyaXB0c0Jsb2NrID0gYXdhaXQgTnVuanVja3NDb21waWxlci5jcmVhdGVTY3JpcHRzQmxvY2socmVwb3J0LCBiaXRzLCBjb21waWxlcnMuanMpO1xuICAgIGxldCBzaGVsbCA9IGF3YWl0IE51bmp1Y2tzQ29tcGlsZXIuY3JlYXRlU2hlbGwocmVwb3J0LCBzdHlsZXNCbG9jaywgc2NyaXB0c0Jsb2NrKTtcbiAgICByZXR1cm4ge1xuICAgICAgaW5kZXg6IGF3YWl0IE51bmp1Y2tzQ29tcGlsZXIucmVuZGVyVGVtcGxhdGUocmVwb3J0LCBzaGVsbCwgdGhpcy5vcHRzKSxcbiAgICAgIHNjcmlwdHM6IHNjcmlwdHNCbG9jayxcbiAgICAgIHN0eWxlczogc3R5bGVzQmxvY2ssXG4gICAgICBjYWNoZVBhdGg6IGpvaW4ocmVwb3J0LndvcmtpbmdEaXJlY3RvcnksICcubGVkZUNhY2hlJylcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIGNyZWF0ZVNjcmlwdHNCbG9jayhyZXBvcnQsIGJpdHMsIGNvbXBpbGVyKSB7XG4gICAgbGV0IHNjcmlwdHMgPSBhd2FpdCBjb21waWxlci5jb21waWxlKHJlcG9ydCwgYml0cyk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGZpbGU6ICdnbG9iYWxTY3JpcHRzLmpzJyxcbiAgICAgIGRhdGE6IGBcbi8vIEdMT0JBTFNcbiR7c2NyaXB0cy5nbG9iYWxzfVxuLy8gQklUU1xuJHtzY3JpcHRzLmJpdHN9XG5gXG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGdldFVzZWRCaXRzKHJlcG9ydCkge1xuICAgIGxldCB2aXNpdGVkQml0cyA9IFtdO1xuICAgIGlmIChyZXBvcnQuY29udGV4dC5jb250ZW50LkFSVElDTEUpIHtcbiAgICAgIGZvciAobGV0IGJpdCBvZiByZXBvcnQuY29udGV4dC5jb250ZW50LkFSVElDTEUpIHtcbiAgICAgICAgaWYgKCEodmlzaXRlZEJpdHMuaW5kZXhPZihiaXQudG1wbCkgPiAtMSkpIHtcbiAgICAgICAgICB2aXNpdGVkQml0cy5wdXNoKGJpdC50bXBsKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdmlzaXRlZEJpdHM7XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgcmVuZGVyVGVtcGxhdGUocmVwb3J0LCB0ZW1wbGF0ZSwgb3B0czoge2ZpbHRlcnM/OiBBcnJheTx7bmFtZTogc3RyaW5nLCBmbjogYW55fT59KSB7XG4gICAgbGV0IGxvYWRlciA9IG5ldyBGaWxlU3lzdGVtTG9hZGVyKCk7XG4gICAgbG9hZGVyLmluaXQoW2pvaW4ocmVwb3J0LndvcmtpbmdEaXJlY3RvcnksICcubGVkZUNhY2hlJywgJ2JpdHMnKV0sIG9wdHMpO1xuICAgIGxldCBlbnYgPSBuZXcgRW52aXJvbm1lbnQobG9hZGVyKTtcbiAgICBpZiAob3B0cy5maWx0ZXJzKSB7XG4gICAgICBmb3IgKGxldCBmIG9mIG9wdHMuZmlsdGVycykge1xuICAgICAgICBlbnYuYWRkRmlsdGVyKGYubmFtZSwgZi5mbilcbiAgICAgIH1cbiAgICB9XG4gICAgbGV0IHRtcGwgPSBuZXcgVGVtcGxhdGUodGVtcGxhdGUsIGVudik7XG4gICAgcmV0dXJuIHRtcGwucmVuZGVyKHJlcG9ydC5jb250ZXh0KTtcbiAgfVxuXG4gIHN0YXRpYyBhc3luYyBjcmVhdGVTdHlsZUJsb2NrKHJlcG9ydCwgYml0cywgY29tcGlsZXIpIHtcbiAgICBsZXQgc3R5bGVzID0gYXdhaXQgY29tcGlsZXIuY29tcGlsZShyZXBvcnQsIGJpdHMpO1xuICAgIHJldHVybiB7XG4gICAgICBmaWxlOiAnZ2xvYmFsU3R5bGVzLmNzcycsXG4gICAgICBkYXRhOiBgXG4vKiBHTE9CQUxTICovXG4ke3N0eWxlcy5nbG9iYWxzfVxuLyogQklUUyAqL1xuJHtzdHlsZXMuYml0c31cbmBcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIGNyZWF0ZVNoZWxsKHJlcG9ydCwgc3R5bGVzQmxvY2ssIHNjcmlwdHNCbG9jaykge1xuICAgIGxldCBwYWdlVG9wID0gYFxuPCFET0NUWVBFIGh0bWw+XG5cbjxodG1sPlxuPGhlYWQ+XG4gIDx0aXRsZT57e3Nlby50aXRsZX19PC90aXRsZT5cbiAgeyUgZm9yIGl0ZW0gaW4gc2VvLm1ldGEgLSV9XG4gIDxtZXRheyVpZiBpdGVtLm5hbWUgJX0gbmFtZT1cInt7aXRlbS5uYW1lfX1cInslIGVuZGlmICV9eyUgaWYgaXRlbS5jb250ZW50ICV9IGNvbnRlbnQ9XCJ7e2l0ZW0uY29udGVudH19XCJ7JSBlbmRpZiAlfXslIGlmIGl0ZW0ucHJvcHMgfCBsZW5ndGggJX17JSBmb3IgcHJvcCBpbiBpdGVtLnByb3BzICV9IHt7cHJvcC5wcm9wfX09XCJ7e3Byb3AudmFsfX1cInslIGVuZGZvciAlfXslIGVuZGlmICV9IC8+XG4gIHslIGVuZGZvciAlfXslIGlmICRkZWJ1ZyAtJX1cbiAgPG1ldGEgTkFNRT1cIlJPQk9UU1wiIENPTlRFTlQ9XCJOT0lOREVYLCBOT0ZPTExPV1wiPlxuICB7JS0gZW5kaWYgJX1cbiAgPGxpbmsgcmVsPVwic3R5bGVzaGVldFwiIHR5cGU9XCJ0ZXh0L2Nzc1wiIGhyZWY9XCIke3N0eWxlc0Jsb2NrLmZpbGV9XCI+XG4gIHslIGlmIGhlYWRMaW5rcyAlfVxuICAgIHslIGZvciBsaW5rIGluIGhlYWRMaW5rcyAlfVxuICAgICAge3sgbGluayB8IHNhZmUgfX1cbiAgICB7JSBlbmRmb3IgJX1cbiAgeyUgZW5kaWYgJX1cbjwvaGVhZD5cbjxib2R5PlxuYDtcblxuICAgIGxldCBwYWdlQm90dG9tID0gYFxuICA8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCIke3NjcmlwdHNCbG9jay5maWxlfVwiPjwvc2NyaXB0PlxuICB7JSBpZiBib2R5TGlua3MgJX1cbiAgICB7JSBmb3IgbGluayBpbiBib2R5TGlua3MgJX1cbiAgICAgIHt7IGxpbmsgfCBzYWZlIH19XG4gICAgeyUgZW5kZm9yICV9XG4gIHslIGVuZGlmICV9XG4gIHslIGlmICRkZWJ1ZyAlfVxuPHNjcmlwdD5cbiAgZG9jdW1lbnQud3JpdGUoJzxzY3JpcHQgc3JjPVwiaHR0cDovLycgKyAobG9jYXRpb24uaG9zdCB8fCAnbG9jYWxob3N0Jykuc3BsaXQoJzonKVswXSArXG4gICc6MzU3MjkvbGl2ZXJlbG9hZC5qcz9zbmlwdmVyPTFcIj48LycgKyAnc2NyaXB0PicpXG48L3NjcmlwdD57JSBlbmRpZiAlfVxuPC9ib2R5PlxuPC9odG1sPlxuYDtcblxuICAgIGxldCBtaWRkbGUgPSAnJztcbiAgICBmb3IgKGxldCBibG9jayBvZiByZXBvcnQuYmxvY2tzKSB7XG4gICAgICBpZiAoYmxvY2sgIT09ICdBUlRJQ0xFJykge1xuICAgICAgICBtaWRkbGUgKz0gYXdhaXQgcmVhZFN0cmVhbVByb20oam9pbihyZXBvcnQud29ya2luZ0RpcmVjdG9yeSwgJy5sZWRlQ2FjaGUnLCAnYmxvY2tzJywgYmxvY2spKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1pZGRsZSArPSBgPGFydGljbGUgaWQ9XCJsZWRlUm9vdFwiIGNsYXNzPVwiY29udGFpbmVyXCI+XG4gICAgICAgICAgPGRpdiBjbGFzcz1cInJvd1wiPlxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cImNvbC1sZy04IGNvbC1sZy1vZmZzZXQtMiBtYWluLWNvbHVtblwiPlxuICAgICAgICAgICAgeyUgZm9yIGJpdCBpbiBjb250ZW50LkFSVElDTEUgJX17JSBpbmNsdWRlIGJpdC50bXBsICsgXCIvdG1wbC5odG1sXCIgJX1cbiAgICAgICAgICAgIHslIGVuZGZvciAlfVxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvYXJ0aWNsZT5gXG4gICAgICB9XG5cbiAgICB9XG5cbiAgICByZXR1cm4gcGFnZVRvcCArIG1pZGRsZSArIHBhZ2VCb3R0b207XG4gIH1cbn0iXSwic291cmNlUm9vdCI6Ii9Vc2Vycy9lbXVycmF5L1dlYnN0b3JtUHJvamVjdHMvbGVkZS9zcmMifQ==
