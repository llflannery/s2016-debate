"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator.throw(value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments)).next());
    });
};
const fs_extra_1 = require('fs-extra');
const rmrf = require('rimraf');
const path_1 = require('path');
const utils_1 = require('../utils');
class CacheBuilder {
    constructor(project) {
        this.project = project;
    }
    buildCache() {
        return __awaiter(this, void 0, void 0, function* () {
            let cacheDir = path_1.join(this.project.workingDirectory, '.ledeCache');
            yield CacheBuilder.createCache(this.project.dependencies, cacheDir);
            yield CacheBuilder.buildDepCache(this.project.dependencies, cacheDir);
        });
    }
    static buildDepCache(deps, buildDir) {
        return __awaiter(this, void 0, void 0, function* () {
            for (let dep of deps) {
                let currPath = dep.workingDir;
                let globalStyles = yield utils_1.globProm("styles/*", currPath);
                let bits = yield utils_1.globProm("bits/*", currPath);
                let scripts = yield utils_1.globProm("scripts/*", currPath);
                let blocks = yield utils_1.globProm("blocks/*", currPath);
                let assets = yield utils_1.globProm("assets/*", currPath);
                for (let s of globalStyles) {
                    yield utils_1.copyProm(path_1.join(currPath, s), path_1.join(buildDir, "styles", dep.name, path_1.basename(s)));
                }
                for (let s of bits) {
                    yield utils_1.copyProm(path_1.join(currPath, s), path_1.join(buildDir, "bits", dep.name, path_1.basename(s)));
                }
                for (let s of scripts) {
                    yield utils_1.copyProm(path_1.join(currPath, s), path_1.join(buildDir, "scripts", dep.name, path_1.basename(s)));
                }
                for (let s of blocks) {
                    yield utils_1.copyProm(path_1.join(currPath, s), path_1.join(buildDir, "blocks", dep.name, path_1.basename(s)));
                }
                for (let s of assets) {
                    yield utils_1.copyProm(path_1.join(currPath, s), path_1.join(buildDir, "assets", dep.name, path_1.basename(s)));
                }
            }
        });
    }
    static createCache(deps, cacheDir) {
        return new Promise((resolve, reject) => {
            fs_extra_1.stat(cacheDir, (err, stats) => {
                if (err && err.code !== 'ENOENT') {
                    reject(err);
                }
                else if (stats && stats.isFile()) {
                    reject(new Error('Cannot have file named .ledeCache in project'));
                }
                else if (stats && stats.isDirectory()) {
                    rmrf(cacheDir, () => {
                        createDirAndDeps(resolve);
                    });
                }
                else {
                    createDirAndDeps(resolve);
                }
            });
        });
        function createDirAndDeps(resolve) {
            return __awaiter(this, void 0, void 0, function* () {
                yield utils_1.createDir(cacheDir);
                for (let dep of deps) {
                    yield utils_1.createDir(path_1.join(cacheDir, 'bits', dep.name));
                    yield utils_1.createDir(path_1.join(cacheDir, 'styles', dep.name));
                    yield utils_1.createDir(path_1.join(cacheDir, 'scripts', dep.name));
                    yield utils_1.createDir(path_1.join(cacheDir, 'blocks', dep.name));
                    yield utils_1.createDir(path_1.join(cacheDir, 'assets', dep.name));
                }
                resolve();
            });
        }
    }
}
exports.CacheBuilder = CacheBuilder;

//# sourceMappingURL=data:application/json;base64,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QUMsQ0FBQyxDQUFDO1FBRUgsMEJBQWdDLE9BQU87O2dCQUNyQyxNQUFNLGlCQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzFCLEdBQUcsQ0FBQyxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ3JCLE1BQU0saUJBQVMsQ0FBQyxXQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDbEQsTUFBTSxpQkFBUyxDQUFDLFdBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO29CQUNwRCxNQUFNLGlCQUFTLENBQUMsV0FBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7b0JBQ3JELE1BQU0saUJBQVMsQ0FBQyxXQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDcEQsTUFBTSxpQkFBUyxDQUFDLFdBQUksQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO2dCQUNyRCxDQUFDO2dCQUNELE9BQU8sRUFBRSxDQUFDO1lBQ1osQ0FBQztTQUFBO0lBQ0gsQ0FBQztBQUNILENBQUM7QUFsRVksb0JBQVksZUFrRXhCLENBQUEiLCJmaWxlIjoibGVkZS9DYWNoZUJ1aWxkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB3cml0ZUpzb24sIHN0YXQsIFN0YXRzLCBta2RpciwgZW5zdXJlRGlyIH0gZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0ICogYXMgcm1yZiBmcm9tICdyaW1yYWYnO1xuaW1wb3J0IHsgam9pbiwgcmVzb2x2ZSBhcyBwcmVzb2x2ZSwgYmFzZW5hbWUgfSBmcm9tICdwYXRoJztcblxuaW1wb3J0IHsgUHJvamVjdFJlcG9ydCwgRGVwZW5kZW5jeSB9IGZyb20gJy4uL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgY29weVByb20sIGdsb2JQcm9tLCBjcmVhdGVEaXIgfSBmcm9tICcuLi91dGlscyc7XG5cbmV4cG9ydCBjbGFzcyBDYWNoZUJ1aWxkZXIge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgcHJvamVjdDogUHJvamVjdFJlcG9ydCkge1xuICB9XG5cbiAgYXN5bmMgYnVpbGRDYWNoZSgpIHtcbiAgICBsZXQgY2FjaGVEaXIgPSBqb2luKHRoaXMucHJvamVjdC53b3JraW5nRGlyZWN0b3J5LCAnLmxlZGVDYWNoZScpO1xuICAgIGF3YWl0IENhY2hlQnVpbGRlci5jcmVhdGVDYWNoZSh0aGlzLnByb2plY3QuZGVwZW5kZW5jaWVzLCBjYWNoZURpcik7XG4gICAgYXdhaXQgQ2FjaGVCdWlsZGVyLmJ1aWxkRGVwQ2FjaGUodGhpcy5wcm9qZWN0LmRlcGVuZGVuY2llcywgY2FjaGVEaXIpO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIGJ1aWxkRGVwQ2FjaGUoZGVwczogQXJyYXk8RGVwZW5kZW5jeT4sIGJ1aWxkRGlyOiBzdHJpbmcpIHtcbiAgZm9yIChsZXQgZGVwIG9mIGRlcHMpIHtcbiAgICAgIGxldCBjdXJyUGF0aCA9IGRlcC53b3JraW5nRGlyO1xuICAgICAgbGV0IGdsb2JhbFN0eWxlcyA9IGF3YWl0IGdsb2JQcm9tKFwic3R5bGVzLypcIiwgY3VyclBhdGgpO1xuICAgICAgbGV0IGJpdHMgPSBhd2FpdCBnbG9iUHJvbShcImJpdHMvKlwiLCBjdXJyUGF0aCk7XG4gICAgICBsZXQgc2NyaXB0cyA9IGF3YWl0IGdsb2JQcm9tKFwic2NyaXB0cy8qXCIsIGN1cnJQYXRoKTtcbiAgICAgIGxldCBibG9ja3MgPSBhd2FpdCBnbG9iUHJvbShcImJsb2Nrcy8qXCIsIGN1cnJQYXRoKTtcbiAgICAgIGxldCBhc3NldHMgPSBhd2FpdCBnbG9iUHJvbShcImFzc2V0cy8qXCIsIGN1cnJQYXRoKTtcbiAgICAgIFxuICAgICAgZm9yIChsZXQgcyBvZiBnbG9iYWxTdHlsZXMpIHtcbiAgICAgICAgYXdhaXQgY29weVByb20oam9pbihjdXJyUGF0aCwgcyksIGpvaW4oYnVpbGREaXIsIFwic3R5bGVzXCIsIGRlcC5uYW1lLCBiYXNlbmFtZShzKSkpXG4gICAgICB9XG4gICAgICBmb3IgKGxldCBzIG9mIGJpdHMpIHtcbiAgICAgICAgYXdhaXQgY29weVByb20oam9pbihjdXJyUGF0aCwgcyksIGpvaW4oYnVpbGREaXIsIFwiYml0c1wiLCBkZXAubmFtZSwgYmFzZW5hbWUocykpKVxuICAgICAgfVxuICAgICAgZm9yIChsZXQgcyBvZiBzY3JpcHRzKSB7XG4gICAgICAgIGF3YWl0IGNvcHlQcm9tKGpvaW4oY3VyclBhdGgsIHMpLCBqb2luKGJ1aWxkRGlyLCBcInNjcmlwdHNcIiwgZGVwLm5hbWUsIGJhc2VuYW1lKHMpKSlcbiAgICAgIH1cbiAgICAgIGZvciAobGV0IHMgb2YgYmxvY2tzKSB7XG4gICAgICAgIGF3YWl0IGNvcHlQcm9tKGpvaW4oY3VyclBhdGgsIHMpLCBqb2luKGJ1aWxkRGlyLCBcImJsb2Nrc1wiLCBkZXAubmFtZSwgYmFzZW5hbWUocykpKVxuICAgICAgfVxuICAgICAgZm9yIChsZXQgcyBvZiBhc3NldHMpIHtcbiAgICAgICAgYXdhaXQgY29weVByb20oam9pbihjdXJyUGF0aCwgcyksIGpvaW4oYnVpbGREaXIsIFwiYXNzZXRzXCIsIGRlcC5uYW1lLCBiYXNlbmFtZShzKSkpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGNyZWF0ZUNhY2hlKGRlcHM6IEFycmF5PERlcGVuZGVuY3k+LCBjYWNoZURpcjogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHN0YXQoY2FjaGVEaXIsIChlcnI6IGFueSwgc3RhdHM6IFN0YXRzKSA9PiB7XG4gICAgICAgIGlmIChlcnIgJiYgZXJyLmNvZGUgIT09ICdFTk9FTlQnKSB7XG4gICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgfSBlbHNlIGlmIChzdGF0cyAmJiBzdGF0cy5pc0ZpbGUoKSkge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ0Nhbm5vdCBoYXZlIGZpbGUgbmFtZWQgLmxlZGVDYWNoZSBpbiBwcm9qZWN0JykpXG4gICAgICAgIH0gZWxzZSBpZiAoc3RhdHMgJiYgc3RhdHMuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgIHJtcmYoY2FjaGVEaXIsICgpID0+IHtcbiAgICAgICAgICAgIGNyZWF0ZURpckFuZERlcHMocmVzb2x2ZSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjcmVhdGVEaXJBbmREZXBzKHJlc29sdmUpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pO1xuXG4gICAgYXN5bmMgZnVuY3Rpb24gY3JlYXRlRGlyQW5kRGVwcyhyZXNvbHZlKSB7XG4gICAgICBhd2FpdCBjcmVhdGVEaXIoY2FjaGVEaXIpO1xuICAgICAgZm9yIChsZXQgZGVwIG9mIGRlcHMpIHtcbiAgICAgICAgYXdhaXQgY3JlYXRlRGlyKGpvaW4oY2FjaGVEaXIsICdiaXRzJywgZGVwLm5hbWUpKTtcbiAgICAgICAgYXdhaXQgY3JlYXRlRGlyKGpvaW4oY2FjaGVEaXIsICdzdHlsZXMnLCBkZXAubmFtZSkpO1xuICAgICAgICBhd2FpdCBjcmVhdGVEaXIoam9pbihjYWNoZURpciwgJ3NjcmlwdHMnLCBkZXAubmFtZSkpO1xuICAgICAgICBhd2FpdCBjcmVhdGVEaXIoam9pbihjYWNoZURpciwgJ2Jsb2NrcycsIGRlcC5uYW1lKSk7XG4gICAgICAgIGF3YWl0IGNyZWF0ZURpcihqb2luKGNhY2hlRGlyLCAnYXNzZXRzJywgZGVwLm5hbWUpKVxuICAgICAgfVxuICAgICAgcmVzb2x2ZSgpO1xuICAgIH1cbiAgfVxufSJdLCJzb3VyY2VSb290IjoiL1VzZXJzL2VtdXJyYXkvV2Vic3Rvcm1Qcm9qZWN0cy9sZWRlL3NyYyJ9
